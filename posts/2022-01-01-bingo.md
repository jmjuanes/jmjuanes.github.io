---
{
    "title": "Bingo Caller",
    "description": "Small bingo game",
    "permalink": "/bingo.html",
    "layout": "default.mustache",
    "collection": "experiments"
}
---
<!--html-->
<div id="app" class="fixed top-0 left-0 w-full h-full min-h-0"></div>
<!--
<div class="fixed top-0 left-0 w-full h-full min-h-0 bg-gray-50 flex flex-col md:flex-row gap-4 p-4">
    <div class="w-full flex flex-col justify-between px-4">
        <div class="text-7xl text-gray-950 font-bold">Bingo.</div>
        <div class="flex flex-col gap-2 h-full">
            <div data-bingo-role="currentCall" style="display:none;">
                <div class="w-full p-4 bg-white rounded-3xl flex items-center flex-col gap-2">
                    <div class="shadow-md bg-white border-gray-900 border-8 rounded-full w-48 h-48 flex items-center justify-center">
                        <div class="bg-gray-900 rounded-full w-40 h-40 flex flex-col items-center justify-center">
                            <span class="text-white text-xs font-bold leading-none mb-1">Bingo</span>
                            <span data-bingo-role="currentCallNumber" class="text-white text-8xl font-black leading-none"></span>
                        </div>
                    </div>
                    <div data-bingo-role="currentCallCount" class="text-center text-xs font-medium">Ball 0 of 90</div>
                </div>
            </div>
            <div data-bingo-role="lastCalls" style="display:none;">
                <div class="w-full p-4 bg-white rounded-3xl flex items-center flex-col gap-2">
                    <div data-bingo-role="lastCallsNumbers" class="w-full grid grid-cols-5 items-center gap-2"></div>
                    <div class="text-center text-gray-700 text-xs font-medium">Last calls</div>
                </div>
            </div>
        </div>
        <div class="flex flex-col gap-2">
            <button data-bingo-role="action" class="w-full p-2 bg-gray-900 text-white text-lg font-bold rounded-full">Start game</button>
            <button data-bingo-role="restart" class="w-full p-2 border-a border-gray-200 bg-white hover:bg-gray-100 text-lg font-bold rounded-full">New game</button>
        </div>
    </div>
    <div class="w-full p-4 bg-gray-900 rounded-3xl">
        <div id="bingo-calls" class="grid grid-cols-10 items-center w-full h-full text-white text-xl"></div>
    </div>
</div>
-->

<script type="module">
    import kofi from "/vendor/kofi.js";

    const MAX_NUMBERS = 90;
    const EXTRACT_INTERVAL_SLOW = 7500;
    const EXTRACT_INTERVAL_FAST = 5000;
    const LANGUAGE_ENGLISH = "EN";
    const LANGUAGE_SPANISH = "ES";
    const LANGUAGES = {
        [LANGUAGE_ENGLISH]: {
            id: LANGUAGE_ENGLISH,
            text: "language.english",
        },
        [LANGUAGE_SPANISH]: {
            id: LANGUAGE_SPANISH,
            text: "language.spanish",
        },
    };
    const GAME_STATUS = {
        NOT_STARTED: "not-started",
        STARTED: "started",
        PAUSED: "paused",
        FINISHED: "finished",
    };
    const EVENTS = {
        RENDER_WELCOME: "render:welcome",
        RENDER_GAME: "render:game",
    };
    const MESSAGES = {
        [LANGUAGE_ENGLISH]: {
            "language": "Language",
            "language.english": "English",
            "language.spanish": "Spanish",
            "play": "Play",
            "lastCalls": "Last Calls",
            "game.start": "Start Game",
            "game.pause": "Pause Game",
            "game.resume": "Resume Game",
            "game.new": "New Game",
        },
        [LANGUAGE_SPANISH]: {
            "language": "Idioma",
            "language.english": "English",
            "language.spanish": "Spanish",
            "play": "Jugar",
            "lastCalls": "Ultimas extracciones",
            "game.start": "Empezar Juego",
            "game.pause": "Parar Juego",
            "game.resume": "Continuar Juego",
            "game.new": "Nuevo Juego",
        },
    };

    const root = document.getElementById("app");
    const bus = kofi.bus();

    // internal state
    const state = {
        language: LANGUAGE_ENGLISH,
        timer: null,
        status: GAME_STATUS.NOT_STARTED,
        calls: [],
        currentCall: -1,
        extractInterval: EXTRACT_INTERVAL_FAST,
    };

    // get translation message
    const t = (key, defaultValue = "") => {
        return MESSAGES[state.language || LANGUAGE_ENGLISH]?.[key] || defaultValue || key;
    };

    // list of UI components
    const ui = {
        Button: (text, onClick) => kofi.html`
            <button className="w-full bg-gray-950 hover:bg-gray-900 text-white text-center p-4 border-0 rounded-full" onClick="${onClick}">
                <span className="text-lg font-bold">${t(text)}</span>
            </button>
        `,
        Tabs: (items, activeItem, onClick) => {
            const content = items.map(item => {
                const currentItem = item?.id || item;
                const className = kofi.classNames({
                    "p-3 rounded-full w-full text-lg text-center font-bold": true,
                    "bg-white text-gray-950 cursor-pointer": currentItem !== activeItem,
                    "bg-gray-950 text-white": currentItem === activeItem,
                });
                return kofi.html`
                    <div className="${className}" onClick="${() => onClick(currentItem)}">
                        <span>${t(item.text || item.id || item)}</span>
                    </div>
                `;
            });
            return kofi.html`
                <div className="border-2 border-gray-950 rounded-full p-1 flex items-center gap-0">
                    ${content}
                </div>
            `;
        },
        Label: (text) => kofi.html`
            <div className="font-bold mb-1 text-center">${t(text)}</div>
        `,
        CurrentCallBall: (ballNumber, ballCount) => kofi.html`
            <div key="${ballNumber}" class="w-full p-4 bg-white rounded-3xl flex items-center flex-col gap-4">
                <div class="shadow-md bg-white border-gray-900 border-8 rounded-full w-60 h-60 flex items-center justify-center">
                    <div class="bg-gray-900 rounded-full w-52 h-52 flex flex-col items-center justify-center">
                        <span class="text-white text-sm font-bold leading-none mb-1">bingo.</span>
                        <span class="text-white text-9xl font-black leading-none">${ballNumber}</span>
                    </div>
                </div>
                <div class="text-center text-sm font-bold">${ballCount} / ${MAX_NUMBERS}</div>
            </div>
        `,
        LastCallBall: (ballNumber) => kofi.html`
            <div key="${ballNumber}" class="w-16 h-16 flex items-center justify-center bg-white rounded-full border-4 border-gray-900">
                <div class="w-12 h-12 flex items-center justify-center bg-gray-900 rounded-full">
                    <span class="text-xl text-white font-bold">${ballNumber}</span>
                </div>
            </div>
        `,
    };

    // create a new html element
    // const html = htmlString => {
    //     return (new DOMParser()).parseFromString(htmlString, "text/html").body.childNodes[0];
    // };

    // generate an array with the privided number of items
    const range = length => {
        return Array.from({length}, (x, index) => index + 1);
    };

    // shuffle the provided array
    const shuffleArray = array => {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            const temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }
        return array;
    };

    // reset game
    const resetGame = () => {
        // 0. stop already initialized game
        if (state.timer) {
            window.clearInterval(state.timer);
        }
        // 1. reset game state
        Object.assign(state, {
            status: GAME_STATUS.NOT_STARTED,
            calls: shuffleArray(range(MAX_NUMBERS)),
            currentCall: -1,
        });
        // 2. render the game screen
        bus.emit(EVENTS.RENDER_GAME);
    };

    // resume the game
    const resumeGame = () => {
        if (state.status !== GAME_STATUS.FINISHED) {
            if (state.status === GAME_STATUS.PAUSED || state.status === GAME_STATUS.NOT_STARTED) {
                const extractNextBall = () => {
                    const hasFinishedGame = !(state.currentCall + 1 < state.calls.length);
                    // 1. if game has finished, clear the timer and set the game as finished
                    if (hasFinishedGame) {
                        state.status = GAME_STATUS.FINISHED;
                        window.clearInterval(state.timer);
                    }
                    // 2. if not, increment the current call and update the number element
                    else {
                        state.currentCall = state.currentCall + 1;
                    }
                    // 3. render again the game
                    bus.emit(EVENTS.RENDER_GAME);
                };
                state.status = GAME_STATUS.STARTED;
                state.timer = window.setInterval(extractNextBall, state.extractInterval);
                extractNextBall(); // extract the next ball
            }
            else {
                state.status = GAME_STATUS.PAUSED;
                window.clearInterval(state.timer);
            }
        }
        bus.emit(EVENTS.RENDER_GAME);
    };

    // render welcome screen
    bus.on(EVENTS.RENDER_WELCOME, () => {
        const onGameStart = () => {
            resetGame();
        };
        const onLanguageChange = newLanguage => {
            state.language = newLanguage;
            bus.emit(EVENTS.RENDER_WELCOME);
        };
        const content = kofi.html`
            <div className="w-full h-full flex items-center justify-center">
                <div className="max-w-md w-full flex flex-col items-center">
                    <div className="font-black text-9xl tracking-tight text-center mb-8">
                        <span>bingo.</span>
                    </div>
                    <div className="w-full mb-4">
                        ${ui.Label("language")}
                        ${ui.Tabs(Object.values(LANGUAGES), state.language, onLanguageChange)}
                    </div>
                    ${ui.Button("play", onGameStart)}
                </div>
            </div>
        `;
        kofi.render(content, root);
    });

    // render game screen
    bus.on(EVENTS.RENDER_GAME, () => {
        const lastCalls = state.currentCall > 0 ? state.calls.slice(0, state.currentCall + 1).reverse().slice(1, 6) : [];
        let actionButtonLabel = "";
        switch (state.status) {
            case GAME_STATUS.NOT_STARTED:
                actionButtonLabel = "game.start";
                break;
            case GAME_STATUS.STARTED:
                actionButtonLabel = "game.pause";
                break;
            case GAME_STATUS.PAUSED:
                actionButtonLabel = "game.resume";
                break;
        }
        const content = kofi.html`
            <div className="w-full h-full min-h-0 flex flex-col md:flex-row gap-4 p-4">
                <div className="w-full flex flex-col justify-between px-4">
                    <div className="flex flex-col gap-2 h-full">
                        ${state.currentCall > -1 ? ui.CurrentCallBall(state.calls[state.currentCall], state.currentCall + 1) : ""}
                        ${lastCalls.length > 0 ? kofi.html`
                            <div className="w-full p-6 bg-gray-100 rounded-3xl flex items-center flex-col gap-2">
                                <div className="w-full grid grid-cols-5 items-center justify-center gap-2">
                                    ${lastCalls.map(number => kofi.html`
                                        <div className="w-full flex justify-center">
                                            ${ui.LastCallBall(number)}
                                        </div>
                                    `)}
                                </div>
                                <div className="text-center opacity-50 text-xs font-medium">
                                    ${t("lastCalls")}
                                </div>
                            </div>
                        ` : ""}
                    </div>
                    <div className="flex flex-col gap-2">
                        ${state.status !== GAME_STATUS.FINISHED ? ui.Button(actionButtonLabel, () => resumeGame()) : ""}
                        ${ui.Button("game.new", () => resetGame())}
                    </div>
                </div>
                <div className="w-full p-4 bg-gray-900 rounded-3xl">
                    <div className="grid grid-cols-10 items-center w-full h-full text-white text-xl">
                        ${range(MAX_NUMBERS).map(number => kofi.html`
                            <div className="text-center" style="opacity:0.25;">
                                <span className="font-bold">${number}</span>
                            </div>
                        `)}
                    </div>
                </div>
            </div>
        `;
        kofi.render(content, root);
    });

    // initialize
    bus.emit(EVENTS.RENDER_WELCOME);

    // // reference to game containers
    // const bingoCallsRef = document.querySelector("#bingo-calls");
    // const bingoCurrentCallRef = document.querySelector(`[data-bingo-role="currentCall"]`);
    // const bingoLastCallsRef = document.querySelector(`[data-bingo-role="lastCalls"]`);
    // const bingoActionRef = document.querySelector(`button[data-bingo-role="action"]`);
    // const bingoRestartRef = document.querySelector(`button[data-bingo-role="restart"]`);

    // // initialize game
    // const initializeGame = (maxNumbers = 90) => {
    //     // 1. reset game state
    //     Object.assign(state, {
    //         gameFinished: false,
    //         gameStarted: false,
    //         gamePaused: false,
    //         calls: shuffleArray(range(maxNumbers)),
    //         currentCall: -1,
    //     });
    //     // 2. reset calls container
    //     bingoCallsRef.replaceChildren();
    //     range(maxNumbers).forEach(number => {
    //         const numberElement = html(`
    //             <div data-number="${number}" class="text-center" style="opacity:0.25;">
    //                 <span>${number}</span>
    //             </div>
    //         `);
    //         bingoCallsRef.appendChild(numberElement);
    //     });
    // };

    // // register listeners for game actions buttons
    // bingoActionRef.addEventListener("click", () => {
    //     if (!state.gameFinished) {
    //         if (state.gamePaused || !state.gameStarted) {
    //             const extractNextBall = () => {
    //                 const hasFinishedGame = !(state.currentCall + 1 < state.calls.length);
    //                 // if game has finished, clear the timer and set the game as finished
    //                 if (hasFinishedGame) {
    //                     state.gameFinished = true;
    //                     bingoActionRef.style.opacity = 0.3;
    //                     return clearInterval(state.timer);
    //                 }
    //                 // if not, increment the current call and update the number element
    //                 state.currentCall = state.currentCall + 1;
    //                 const number = state.calls[state.currentCall];
    //                 bingoCallsRef.querySelector(`div[data-number="${number}"]`).style.opacity = 1;
    //                 // update current call number
    //                 bingoCurrentCallRef.style.display = "block";
    //                 bingoCurrentCallRef.querySelector(`[data-bingo-role="currentCallNumber"]`).textContent = number;
    //                 bingoCurrentCallRef.querySelector(`[data-bingo-role="currentCallCount"]`).textContent = `Ball ${state.currentCall + 1} of ${state.calls.length}`;
    //                 // update last calls
    //                 if (state.currentCall > 0) {
    //                     bingoLastCallsRef.style.display = "block"; // display last calls container
    //                     const lastCalls = state.calls.slice(0, state.currentCall + 1).reverse().slice(1, 6);
    //                     const lastCallsContainer = bingoLastCallsRef.querySelector(`[data-bingo-role="lastCallsNumbers"]`);
    //                     lastCallsContainer.replaceChildren();
    //                     lastCalls.forEach(lastCall => {
    //                         const lastCallElement = html(`
    //                             <div class="w-16 h-16 flex items-center justify-center bg-white rounded-full border-4 border-gray-900">
    //                                 <div class="w-12 h-12 flex items-center justify-center bg-gray-900 rounded-full">
    //                                     <span class="text-xl text-white font-bold">${lastCall}</span>
    //                                 </div>
    //                             </div>
    //                         `);
    //                         lastCallsContainer.appendChild(lastCallElement);
    //                     });
    //                 }
    //             };
    //             state.gamePaused = false;
    //             state.timer = window.setInterval(extractNextBall, state.extractInterval);
    //             bingoActionRef.textContent = "Pause game";
    //         }
    //         else {
    //             state.gamePaused = true;
    //             clearInterval(state.timer);
    //             bingoActionRef.textContent = "Resume game";
    //         }
    //     }
    //     state.gameStarted = true;
    // });

    // // register listener for restart button
    // bingoRestartRef.addEventListener("click", () => {
    //     if (state.gameStarted && !state.gameFinished) {
    //         clearInterval(state.timer);
    //     }
    //     bingoActionRef.style.opacity = 1; // reset opacity for action button
    //     bingoActionRef.textContent = "Start game"; // reset text for action button
    //     bingoCurrentCallRef.style.display = "none";
    //     bingoLastCallsRef.style.display = "none";
    //     initializeGame();
    // });

    // // initialize game
    // initializeGame();
</script>
<!--/html-->
