---
{
    "title": "Bingo Caller",
    "description": "Small bingo game",
    "permalink": "/bingo/index.html",
    "layout": "default.mustache",
    "collection": "experiments"
}
---
<!--html-->
<div id="app" class="fixed top-0 left-0 w-full h-full min-h-0"></div>

<script type="module">
    import kofi from "/vendor/kofi.js";

    const MAX_NUMBERS = 90;
    const EXTRACT_INTERVAL_SLOW = 7500;
    const EXTRACT_INTERVAL_FAST = 5000;
    const LANGUAGES = {
        ENGLISH: "en-US",
        SPANISH: "es-ES",
    };
    const GAME_STATUS = {
        NOT_STARTED: "not-started",
        STARTED: "started",
        PAUSED: "paused",
        FINISHED: "finished",
    };
    const EVENTS = {
        RENDER_WELCOME: "render:welcome",
        RENDER_GAME: "render:game",
    };
    const MESSAGES = {
        [LANGUAGES.ENGLISH]: {
            "language": "Language",
            "language.english": "English",
            "language.spanish": "Spanish",
            "play": "Play",
            "lastCalls": "Last Calls",
            "game.start": "Start Game",
            "game.pause": "Pause Game",
            "game.resume": "Resume Game",
            "game.new": "New Game",
            "game.exit": "Exit Game",
            "speak": "Speak numbers",
            "speak.enabled": "On",
            "speak.disabled": "Off", 
        },
        [LANGUAGES.SPANISH]: {
            "language": "Idioma",
            "language.english": "English",
            "language.spanish": "Spanish",
            "play": "Jugar",
            "lastCalls": "Ultimas extracciones",
            "game.start": "Empezar Juego",
            "game.pause": "Parar Juego",
            "game.resume": "Continuar Juego",
            "game.new": "Nuevo Juego",
            "game.exit": "Salir",
            "speak": "Cantar nÃºmeros",
            "speak.enabled": "Si",
            "speak.disabled": "No",
        },
    };

    const root = document.getElementById("app");
    const bus = kofi.bus();

    // internal state
    const state = {
        language: LANGUAGES.ENGLISH,
        speak: true,
        timer: null,
        status: GAME_STATUS.NOT_STARTED,
        calls: [],
        currentCall: -1,
        extractInterval: EXTRACT_INTERVAL_FAST,
    };

    // get translation message
    const t = (key, defaultValue = "") => {
        return MESSAGES[state.language || LANGUAGES.ENGLISH]?.[key] || defaultValue || key;
    };

    // get the number to speak
    const autoChant = (num = 0) => {
        return num < 10 ? String(num) : [String(num), ...String(num).split("")].join(", ");
    };

    // speak the provided text
    const speak = (text, lang = "es-ES") => {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = lang;
        speechSynthesis.speak(utter);
    };

    // list of UI components
    const ui = {
        Button: props => {
            const className = kofi.classNames({
                "block w-full text-center p-4 border-0 rounded-full": true,
                "bg-gray-950 hover:bg-gray-900 text-white": !props.secondary,
                "bg-white hover:bg-gray-100 border-2 border-gray-950": !!props.secondary,
                "cursor-pointer": !props.disabled,
                "pointer-events-none opacity-70": !!props.disabled,
            });
            return kofi.html`
                <button key="${props.key || props.text}" className="${className}" onClick="${props.onClick}">
                    <span className="text-lg font-bold">${props.text}</span>
                </button>
            `;
        },
        Separator: () => kofi.html`
            <div className="w-full border-t-2 border-gray-950 my-2"></div>
        `,
        Tabs: props => {
            const content = (props.data || props.items || []).map((item, index) => {
                const value = item?.value ?? item;
                const className = kofi.classNames({
                    "p-3 rounded-full w-full text-lg text-center font-bold": true,
                    "bg-white text-gray-950 cursor-pointer": value !== props.value,
                    "bg-gray-950 text-white": value === props.value,
                });
                return kofi.html`
                    <div key="${index}" className="${className}" onClick="${() => props.onClick(value)}">
                        <span>${item?.text || item?.id || item}</span>
                    </div>
                `;
            });
            return kofi.html`
                <div className="border-2 border-gray-950 rounded-full p-1 flex items-center gap-0">
                    ${content}
                </div>
            `;
        },
        Label: props => kofi.html`
            <div className="font-bold mb-1 text-center">${props.text}</div>
        `,
        CurrentCallBall: props => kofi.html`
            <div key="${props.current}" class="w-full p-4 bg-white rounded-3xl flex items-center flex-col gap-4">
                <div class="shadow-md bg-white border-gray-900 border-8 rounded-full w-60 h-60 flex items-center justify-center">
                    <div class="bg-gray-900 rounded-full w-52 h-52 flex flex-col items-center justify-center">
                        <span class="text-white text-sm font-bold leading-none mb-1">bingo.</span>
                        <span class="text-white text-9xl font-black leading-none">${props.current}</span>
                    </div>
                </div>
                <div class="text-center text-sm font-bold">${props.count} / ${props.total}</div>
            </div>
        `,
        LastCallBall: props => kofi.html`
            <div key="${props.current}" class="w-16 h-16 flex items-center justify-center bg-white rounded-full border-4 border-gray-900">
                <div class="w-12 h-12 flex items-center justify-center bg-gray-900 rounded-full">
                    <span class="text-xl text-white font-bold">${props.current}</span>
                </div>
            </div>
        `,
    };

    // generate an array with the privided number of items
    const range = length => {
        return Array.from({length}, (x, index) => index + 1);
    };

    // shuffle the provided array
    const shuffleArray = array => {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            const temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }
        return array;
    };

    // reset game
    const resetGame = () => {
        // 0. stop already initialized game
        if (state.timer) {
            window.clearInterval(state.timer);
        }
        // 1. reset game state
        Object.assign(state, {
            status: GAME_STATUS.NOT_STARTED,
            calls: shuffleArray(range(MAX_NUMBERS)),
            currentCall: -1,
        });
        // 2. render the game screen
        bus.emit(EVENTS.RENDER_GAME);
    };

    // resume the game
    const resumeGame = () => {
        if (state.status !== GAME_STATUS.FINISHED) {
            if (state.status === GAME_STATUS.PAUSED || state.status === GAME_STATUS.NOT_STARTED) {
                const extractNextBall = () => {
                    const hasFinishedGame = !(state.currentCall + 1 < state.calls.length);
                    // 1. if game has finished, clear the timer and set the game as finished
                    if (hasFinishedGame) {
                        state.status = GAME_STATUS.FINISHED;
                        window.clearInterval(state.timer);
                    }
                    // 2. if not, increment the current call and update the number element
                    else {
                        state.currentCall = state.currentCall + 1;
                        if (state.speak) {
                            const currentNumber = state.calls[state.currentCall];
                            speak(autoChant(currentNumber), state.language);
                        }
                    }
                    // 3. render again the game
                    bus.emit(EVENTS.RENDER_GAME);
                };
                state.status = GAME_STATUS.STARTED;
                state.timer = window.setInterval(extractNextBall, state.extractInterval);
                extractNextBall(); // extract the next ball
            }
            else {
                state.status = GAME_STATUS.PAUSED;
                window.clearInterval(state.timer);
            }
        }
        bus.emit(EVENTS.RENDER_GAME);
    };

    // render welcome screen
    bus.on(EVENTS.RENDER_WELCOME, () => {
        kofi.render(kofi.html`
            <div className="w-full h-full flex items-center justify-center">
                <div className="max-w-md w-full flex flex-col items-center">
                    <div className="font-black text-9xl tracking-tight text-center mb-8">
                        <span>bingo.</span>
                    </div>
                    <div className="w-full mb-4">
                        ${ui.Label({ text: t("language") })}
                        ${ui.Tabs({
                            data: [
                                { value: LANGUAGES.ENGLISH, text: t("language.english") },
                                { value: LANGUAGES.SPANISH, text: t("language.spanish") },
                            ],
                            value: state.language,
                            onClick: languageValue => {
                                state.language = languageValue;
                                bus.emit(EVENTS.RENDER_WELCOME);
                            },
                        })}
                    </div>
                    <div className="w-full mb-4">
                        ${ui.Label({ text: t("speak") })}
                        ${ui.Tabs({
                            data: [
                                { value: true, text: t("speak.enabled") },
                                { value: false, text: t("speak.disabled") },
                            ],
                            value: state.speak,
                            onClick: speakValue => {
                                state.speak = speakValue;
                                bus.emit(EVENTS.RENDER_WELCOME);
                            },
                        })}
                    </div>
                    ${ui.Button({
                        text: t("play"),
                        onClick: () => resetGame(),
                    })}
                </div>
            </div>
        `, root);
    });

    // render game screen
    bus.on(EVENTS.RENDER_GAME, () => {
        const extractedCalls = new Set(state.currentCall >= 0 ? state.calls.slice(0, state.currentCall + 1) : []);
        const lastCalls = state.currentCall > 0 ? state.calls.slice(0, state.currentCall + 1).reverse().slice(1, 6) : [];
        let actionButtonLabel = "";
        switch (state.status) {
            case GAME_STATUS.NOT_STARTED:
                actionButtonLabel = "game.start";
                break;
            case GAME_STATUS.STARTED:
                actionButtonLabel = "game.pause";
                break;
            case GAME_STATUS.PAUSED:
                actionButtonLabel = "game.resume";
                break;
        }
        const onGameExit = () => {
            window.clearInterval(state.timer);
            bus.emit(EVENTS.RENDER_WELCOME);
        };
        const content = kofi.html`
            <div className="w-full h-full min-h-0 flex flex-col md:flex-row gap-4 p-4">
                <div className="w-full flex flex-col justify-between px-4">
                    <div className="flex flex-col gap-2 h-full">
                        ${state.currentCall > -1 ? ui.CurrentCallBall({
                            current: state.calls[state.currentCall],
                            count: state.currentCall + 1,
                            total: MAX_NUMBERS,
                        }) : ""}
                        ${lastCalls.length > 0 ? kofi.html`
                            <div className="w-full p-6 bg-gray-100 rounded-3xl flex items-center flex-col gap-2">
                                <div className="w-full grid grid-cols-5 items-center justify-center gap-2">
                                    ${lastCalls.map(number => kofi.html`
                                        <div className="w-full flex justify-center">
                                            ${ui.LastCallBall({ current: number })}
                                        </div>
                                    `)}
                                </div>
                                <div className="text-center opacity-50 text-xs font-medium">
                                    ${t("lastCalls")}
                                </div>
                            </div>
                        ` : ""}
                    </div>
                    <div className="flex flex-col gap-2">
                        ${ui.Button({
                            disabled: state.status === GAME_STATUS.FINISHED,
                            text: t(actionButtonLabel),
                            onClick: resumeGame,
                        })}
                        ${ui.Separator()}
                        ${ui.Button({ secondary: true, text: t("game.new"), onClick: resetGame })}
                        ${ui.Button({ secondary: true, text: t("game.exit"), onClick: onGameExit })}
                    </div>
                </div>
                <div className="w-full p-4 bg-gray-900 rounded-3xl">
                    <div className="grid grid-cols-10 items-center w-full h-full text-white text-xl">
                        ${range(MAX_NUMBERS).map(number => kofi.html`
                            <div className="text-center" style="${`opacity:${extractedCalls.has(number) ? 1 : 0.25};`}">
                                <span className="font-bold">${number}</span>
                            </div>
                        `)}
                    </div>
                </div>
            </div>
        `;
        kofi.render(content, root);
    });

    // initialize
    bus.emit(EVENTS.RENDER_WELCOME);
</script>
<!--/html-->
