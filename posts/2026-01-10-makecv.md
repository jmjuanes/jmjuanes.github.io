---
{
    "title": "makecv",
    "description": "Tiny curriculum builder.",
    "date": "January 10, 2026",
    "permalink": "/makecv/index.html",
    "layout": "default.mustache",
    "draft": true,
    "collection": "experiments"
}
---
<!--html-->
<div id="app" class="fixed top-0 left-0 w-full h-full min-h-0" style="display:none;"></div>
<div id="landing" class="w-full" style="display:none;"></div>

<script type="module">
    import kofi from "/vendor/kofi.js";

    // reference to dom containers
    const appContainer = document.querySelector(`div#app`);
    const landingContainer = document.querySelector(`div#landing`);

    // global variables
    const EVENTS = {
        INIT: "init",
        CREATE_ELEMENT: "element:create",
        DELETE_ELEMENT: "element:delete",
        REORDER_ELEMENT: "element:reorder",
        SET_ACTIVE_ELEMENT: "element:set-active",
        CLEAR_ACTIVE_ELEMENT: "element:clear-active",
        RENDER_EDITOR: "render:editor",
        RENDER_PREVIEW: "render:preview",
    };
    const LEFT_SIDE_TABS = {
        LAYERS: "tab:layers",
        ELEMENTS: "tab:elements",
    };
    const FORM_TYPES = {
        TEXT: "text",
    };
    const ELEMENT_TYPES = {
        HEADING: "heading",
        PARAGRAPH: "paragraph",
    };
    const ELEMENTS = {
        [ELEMENT_TYPES.HEADING]: {
            title: "Heading",
            description: "Bigger heading.",
            icon: "heading-1",
            fields: {
                text: {
                    type: FORM_TYPES.TEXT,
                    title: "Content",
                    initialValue: "",
                },
            },
        },
        [ELEMENT_TYPES.PARAGRAPH]: {
            title: "Paragraph",
            description: "Multi-line input.",
            icon: "text-left",
            fields: {
                text: {
                    type: FORM_TYPES.TEXT,
                    title: "Content",
                    initialValue: "",
                },
            },
        },
    };

    // renderer for form options
    const FormOptions = {
        [FORM_TYPES.TEXT]: props => {
            const className = kofi.directives.classMap({
                "block w-full bg-white border-1 border-gray-200 px-2 py-1 h-8 text-sm rounded-lg": true,
            });
            const handleChange = event => {
                return props.onChange(event.target.value || "");
            };
            return kofi.html`
                <input type="text" className="${className}" value="${props.value}" onChange="${handleChange}" />
            `;
        },
    };

    // application components
    const ui = {
        Icon: props => kofi.html`
            <svg width="1em" height="1em">
                <svg:use href="${"/vendor/icons.svg#" + props.icon}" />
            </svg>
        `,
        Tabs: props => {
            const content = (props.items || props.tabs || []).map(tab => {
                const className = kofi.directives.classMap({
                    "w-full text-center px-2 py-1 rounded-md leading-none": true,
                    "bg-white shadow-sm": props.value === tab.value,
                    "cursor-pointer hover:bg-white": props.value !== tab.value,
                });
                return kofi.html`
                    <div className="${className}" onClick="${() => props.onChange(tab.id || tab.value)}">
                        <span className="font-bold text-sm">${tab.name || tab.text}</span>
                    </div>
                `;
            });
            return kofi.html`
                <div className="flex items-center gap-2 w-full bg-gray-100 p-1 rounded-lg">
                    ${content}
                </div>
            `;
        },
        Logo: () => kofi.html`
            <div className="flex items-center leading-none tracking-tight gap-1 select-none">
                <div className="flex items-center">
                    ${ui.Icon({ icon: "article" })}
                </div>
                <div className="flex items-center">
                    <div className="font-bold">make</div>
                    <div className="font-light opacity-60">cv</div>
                </div>
            </div>
        `,
        Header: props => kofi.html`
            <div className="shrink-0 bg-white text-gray-950 flex flex-row items-center justify-between h-14 px-4 py-3">
                <div className="text-2xl">
                    ${ui.Logo()}
                </div>
                ${props.rightContent ? props.rightContent() : ""}
            </div>
        `,
        Form: props => kofi.html`
            <div className="flex flex-col gap-4">
                ${Object.keys(props.fields).map(field => kofi.html`
                    <div className="flex flex-col gap-1">
                        ${props.fields[field].title ? kofi.html`
                            <div className="font-bold text-sm">${props.fields[field].title}</div>
                        ` : ""}
                        ${FormOptions[props.fields[field].type]({
                            value: props.data[field],
                            disabled: false,
                            onChange: value => props.onChange(field, value),
                        })}
                    </div>
                `)}
            </div>
        `,
        LeftSideLayers: props => {
            const itemHeight = 44;
            const containerStyle = {
                height: `${props.layers.length * itemHeight}px`,
            };
            const content = props.layers.map((layer, index) => {
                const className = kofi.directives.classMap({
                    "group absolute w-full rounded-lg overflow-hidden flex items-center select-none": true,
                    "bg-gray-100": layer.id === props.activeLayer,
                    "hover:bg-gray-100 cursor-pointer": layer.id !== props.activeLayer,
                });
                const layerStyle = kofi.directives.styleMap({
                    top: `${index * itemHeight}px`,
                    height: `36px`,
                    cursor: "grab",
                    zIndex: "0",
                });
                const handleMove = event => {
                    event.preventDefault();
                    const itemElement = event.currentTarget.parentElement;
                    const parentElement = itemElement.parentElement;
                    itemElement.style.zIndex = "100";
                    itemElement.style.cursor = "grabbing";
                    // 2. create the move handler
                    const handlePointerMove = moveEvent => {
                        const { top, height } = parentElement.getBoundingClientRect();
                        const itemPosition = Math.max(0, Math.min(moveEvent.clientY - top - (itemHeight / 2), height - itemHeight));
                        const itemOriginalIndex = parseInt(itemElement.getAttribute("data-original-index"), 10);
                        const itemCurrentIndex = parseInt(itemElement.getAttribute("data-current-index"), 10);
                        const itemNextIndex = Math.floor((itemPosition + (itemHeight / 2)) / itemHeight);
                        // reorder the layers visually
                        Array.from(parentElement.children).forEach(childElement => {
                            if (childElement !== itemElement) {
                                const childCurrentlIndex = parseInt(childElement.getAttribute("data-current-index"), 10);
                                if (childCurrentlIndex === itemNextIndex) {
                                    // move the child to the original position of the dragged item
                                    childElement.style.top = `${itemCurrentIndex * itemHeight}px`;
                                    childElement.setAttribute("data-current-index", itemCurrentIndex);
                                }
                            }
                        });
                        // update the item element attributes
                        itemElement.setAttribute("data-current-index", itemNextIndex);
                        itemElement.style.top = `${itemPosition}px`;
                    };
                    // 3. create the up handler
                    const handlePointerUp = upEvent => {
                        document.removeEventListener("pointermove", handlePointerMove);
                        document.removeEventListener("pointerup", handlePointerUp);
                        document.removeEventListener("pointerleave", handlePointerUp);
                        // emit the move event
                        const itemOriginalIndex = parseInt(itemElement.getAttribute("data-original-index"), 10);
                        const itemCurrentIndex = parseInt(itemElement.getAttribute("data-current-index"), 10);
                        if (itemOriginalIndex !== itemCurrentIndex && typeof props.onMove === "function") {
                            props.onMove(layer, itemOriginalIndex, itemCurrentIndex);
                        }
                        // reset item element styles
                        itemElement.style.cursor = "";
                        itemElement.style.zIndex = "0";
                        itemElement.style.top = `${itemCurrentIndex * itemHeight}px`;
                    };
                    // 4. attach the move and up handlers
                    document.addEventListener("pointermove", handlePointerMove);
                    document.addEventListener("pointerup", handlePointerUp);
                    document.addEventListener("pointerleave", handlePointerUp);
                };
                return kofi.html`
                    <div key="${layer.id}" className="${className}" data-original-index="${index}" data-current-index="${index}" style="${layerStyle}">
                        <div className="flex items-center text-xl px-3 py-2 shrink-0" onPointerDown="${handleMove}">
                            ${ui.Icon({ icon: ELEMENTS[layer.type].icon })}
                        </div>
                        <div className="font-bold text-sm pr-3 py-2 w-full leading-none overflow-hidden" onClick="${() => props.onClick(layer)}">
                            <span>${layer.name || layer.id}</span>
                        </div>
                        <div className="flex gap-1 items-center shrink-0 opacity-0 group-hover:opacity-100">
                            <div className="cursor-pointer flex opacity-40 hover:opacity-80 px-2 py-1" onClick="${() => props.onDelete(layer)}">
                                ${ui.Icon({ icon: "trash" })}
                            </div>
                        </div>
                    </div>
                `;
            });
            return kofi.html`
                <div className="w-full relative" style="${containerStyle}">
                    ${content}
                </div>
            `;
        },
        LeftSideElements: props => kofi.html`
            <div className="flex flex-col gap-4">
                ${Object.keys(ELEMENTS).map(key => kofi.html`
                    <div key="${key}" className="group flex gap-3 items-center cursor-pointer" onClick="${() => props.onClick(key)}">
                        <div className="bg-gray-100 rounded-md p-2 shrink-0 flex items-center text-xl">
                            <div className="flex group-hover:hidden items-center">
                                ${ui.Icon({ icon: ELEMENTS[key].icon})}
                            </div>
                            <div className="hidden group-hover:flex">
                                ${ui.Icon({ icon: "plus" })}
                            </div>
                        </div>
                        <div className="w-full grow-1 flex flex-col justify-center">
                            <div className="font-bold text-sm">${ELEMENTS[key].title}</div>
                            <div className="opacity-60 text-xs">${ELEMENTS[key].description}</div>
                        </div>
                    </div>
                `)}
            </div>
        `,
    };

    // create the app instance
    const app = kofi.emitter({
        [EVENTS.INIT]: () => {
            Object.assign(app.state, {
                data: {
                    elements: [
                        {
                            id: "heading01",
                            type: ELEMENT_TYPES.HEADING,
                            text: "Hello World",
                        },
                        {
                            id: "paragraph01",
                            type: ELEMENT_TYPES.PARAGRAPH,
                            text: "Hello world",
                        },
                        {
                            id: "paragraph02",
                            type: ELEMENT_TYPES.PARAGRAPH,
                            text: "This is a paragraph.",
                        },
                    ],
                },
                activeElement: null,
                activeLeftSideTab: LEFT_SIDE_TABS.LAYERS,
            });
            app.state.activeElement = app.state.data.elements[0];
            appContainer.style.display = "";
            app.emit(EVENTS.RENDER_EDITOR);
        },
        [EVENTS.CREATE_ELEMENT]: ({ type }) => {
            // 1. initialize new element configuration
            const elementConfig = ELEMENTS[type];
            const element = {
                type: type,
                id: kofi.directives.uid(),
            };
            // 2. assign element fields
            Object.keys(elementConfig.fields || {}).forEach(field => {
                element[field] = elementConfig.fields[field].initialValue;
            });
            // 3. insert the element and update
            app.state.data.elements.push(element);
            app.state.activeElement = element; // change active element
            app.state.activeLeftSideTab = LEFT_SIDE_TABS.LAYERS; // tange to layers
            app.emit(EVENTS.RENDER_EDITOR);
        },
        [EVENTS.DELETE_ELEMENT]: ({ element }) => {
            // 1. remove this elements from the tree
            app.state.data.elements = app.state.data.elements.filter(el => {
                return el.id !== element?.id;
            });
            // 2. reset the active element if it is the deleted element
            if (app.state.activeElement?.id === element?.id) {
                app.state.activeElement = null;
            }
            // 3. update the view
            app.emit(EVENTS.RENDER_EDITOR);
        },
        [EVENTS.REORDER_ELEMENT]: ({ element, fromIndex, toIndex }) => {
            const elements = app.state.data.elements;
            const [ movedElement ] = elements.splice(fromIndex, 1);
            elements.splice(toIndex, 0, movedElement);
            app.emit(EVENTS.RENDER_EDITOR);
        },
        [EVENTS.SET_ACTIVE_ELEMENT]: ({ element }) => {
            app.state.activeElement = app.state.data.elements.find(el => {
                return el === element || el.id === element;
            });
            app.emit(EVENTS.RENDER_EDITOR);
        },
        [EVENTS.CLEAR_ACTIVE_ELEMENT]: () => {
            app.state.activeElement = null;
            app.emit(EVENTS.RENDER_EDITOR);
        },
        [EVENTS.RENDER_EDITOR]: () => {
            kofi.render(kofi.html`
                <div className="w-full h-full min-h-0 flex flex-col bg-white">
                    ${ui.Header({})}
                    <div className="grow-1 h-full w-full flex items-stretch">
                        <div className="w-full max-w-64 h-full shrink-0 p-4">
                            <div className="w-full py-4">
                                ${ui.Tabs({
                                    items: [
                                        { value: LEFT_SIDE_TABS.LAYERS, text: "Layers" },
                                        { value: LEFT_SIDE_TABS.ELEMENTS, text: "Elements" },
                                    ],
                                    value: app.state.activeLeftSideTab,
                                    onChange: tabValue => {
                                        app.state.activeLeftSideTab = tabValue;
                                        app.emit(EVENTS.RENDER_EDITOR);
                                    },
                                })}
                            </div>
                            ${app.state.activeLeftSideTab === LEFT_SIDE_TABS.LAYERS ? kofi.html`
                                <div className="w-full py-4 overflow-y-scroll h-full">
                                    ${ui.LeftSideLayers({
                                        layers: app.state?.data?.elements || [],
                                        activeLayer: app.state.activeElement?.id || "",
                                        onMove: (element, fromIndex, toIndex) => {
                                            app.emit(EVENTS.REORDER_ELEMENT, { element, fromIndex, toIndex });
                                        },
                                        onClick: element => {
                                            app.emit(EVENTS.SET_ACTIVE_ELEMENT, { element });
                                        },
                                        onDelete: element => {
                                            app.emit(EVENTS.DELETE_ELEMENT, {Â element });
                                        },
                                    })}
                                </div>
                            ` : ""}
                            ${app.state.activeLeftSideTab === LEFT_SIDE_TABS.ELEMENTS ? kofi.html`
                                <div className="w-full py-4 overflow-y-scroll h-full">
                                    ${ui.LeftSideElements({
                                        onClick: elementType => {
                                            app.emit(EVENTS.CREATE_ELEMENT, { type: elementType });
                                        },
                                    })}
                                </div>
                            ` : ""}
                        </div>
                        <div className="relative w-full h-full p-4 border-1 border-gray-200 overflow-scroll rounded-xl bg-white">
                            <div className="fixed bottom-0 right-0 mb-4 mr-4">
                                <div className="gr-gray-100 rounded-full px-3 py-2 text-sm">Preview</div>
                            </div>
                        </div>
                        ${kofi.directives.when(!!app.state.activeElement, () => kofi.html`
                            <div className="relative w-full max-w-md h-full shrink-0 p-4">
                                <div className="sticky top-0 w-full bg-white pb-4 flex items-center justify-between">
                                    <div className="font-bold">
                                        <span>${ELEMENTS[app.state.activeElement.type].title}</span>
                                    </div>
                                    <div className="flex text-2xl opacity:60 hover:opacity-100 cursor-pointer" onClick="${() => app.emit(EVENTS.CLEAR_ACTIVE_ELEMENT)}">
                                        ${ui.Icon({ icon: "x" })}
                                    </div>
                                </div>
                                ${ui.Form({
                                    data: app.state.activeElement,
                                    fields: ELEMENTS[app.state.activeElement.type].fields,
                                    onChange: (field, value) => {
                                        app.state.activeElement[field] = value;
                                        // TODO: debounce reloading preview
                                    },
                                })}
                            </div>
                        `)}
                    </div>
                </div>
            `, appContainer);
        },
        [EVENTS.RENDER_PREVIEW]: () => {
            return null;
        },
    });

    // initialize the app
    app.emit(EVENTS.INIT);
</script>
<!--/html-->
